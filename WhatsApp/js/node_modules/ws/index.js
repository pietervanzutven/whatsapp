require((exports,module) => {

    class ws {
        constructor(url, protocols, options) {
            this.url = Windows.Foundation.Uri(url);
            this.socket = new Windows.Networking.Sockets.MessageWebSocket();
            this.socket.control.messageType = Windows.Networking.Sockets.SocketMessageType.utf8;
            this.socket.setRequestHeader("origin", options.origin);
            for (const header in options.headers) {
                this.socket.setRequestHeader(header, options.headers[header]);
            }
            this.socket.onmessagereceived = function (event) {
                const dataReader = event.getDataReader();
                let result;
                if (event.messageType == Windows.Networking.Sockets.SocketMessageType.binary) {
                    const buffer = dataReader.readBuffer(dataReader.unconsumedBufferLength);
                    const array = Windows.Security.Cryptography.CryptographicBuffer.copyToByteArray(buffer);
                    result = Buffer.from(array);

                } else if (event.messageType == Windows.Networking.Sockets.SocketMessageType.utf8) {
                    dataReader.unicodeEncoding = Windows.Storage.Streams.UnicodeEncoding.utf8;
                    result = dataReader.readString(dataReader.unconsumedBufferLength);
                } else {
                    throw "Socket receive error: unknown message type";
                }
                this.onmessage(result);
            }.bind(this);
            this.socket.onclosed = function (message) {
                this.onclose();
            }.bind(this);
            this.on = async function (type, callback) {
                this["on" + type] = callback;
                if (type === "open") {
                    await this.socket.connectAsync(this.url);
                    this.onopen();
                }
            }
            this.once = this.on;
            this.removeAllListeners = function (type) {
                this.socket['on' + type] = null;
                return this;
            }
            this.close = this.socket.close;
            this.send = async function (message) {
                const dataWriter = Windows.Storage.Streams.DataWriter(this.socket.outputStream);
                dataWriter.writeString(message);
                await dataWriter.storeAsync();
                dataWriter.detachStream();
            }
        }
    }

    module.exports = ws;
});